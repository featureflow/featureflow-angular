!function(e){"use strict";var i="1.3.4",t=void 0;var n=void 0,r={events:[]},o=function(){var e=[];0<r.events.length&&(e.push.apply(e,function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(r.events)),r.events=[],a(t.eventsUrl+"/api/js/v1/event/"+t.apiKey,{method:"POST",body:e})),n=null},s=function(){n||(n=setTimeout(o,4e3))};function a(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:function(){},r=new XMLHttpRequest;return r.addEventListener("load",function(){200===r.status&&"application/json;charset=UTF-8"===r.getResponseHeader("Content-Type")?n(null,JSON.parse(r.responseText)):n(r.statusText||"non 200 response status code")}),r.addEventListener("error",function(){n("error connecting with server")}),r.open(t.method,e),r.setRequestHeader("X-Featureflow-Client","JavascriptClient/"+i),t.body?(r.setRequestHeader("Content-Type","application/json"),r.send(JSON.stringify(t.body))):r.send(),r}var u=function(e){t.baseUrl=e},f=function(e){t.eventsUrl=e},c=function(e){t.apiKey=e},l=function(e,t,n){var r,i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:[],o=arguments[4],s=0<i.length?"?keys="+i.join(","):"";a(e+"/api/js/v1/evaluate/"+t+"/user/"+encodeURI((r=n,btoa(JSON.stringify(r))))+s,{method:"GET"},o)},v=function(e,t,n){return s(r.events.push({type:"goal",goalKey:t,impressions:1,evaluatedFeatures:n,timestamp:new Date,user:e}))},h=function(e,t,n){return s(r.events.push({type:"evaluate",featureKey:t,evaluatedVariant:n,impressions:1,user:e,timestamp:new Date}))},p=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();var d=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.storedValue=e.toLowerCase()}return p(t,[{key:"value",value:function(){return this.storedValue}},{key:"is",value:function(e){return e.toLowerCase()===this.value().toLowerCase()}},{key:"isOn",value:function(){return this.is("on")}},{key:"isOff",value:function(){return this.is("off")}}]),t}(),y={INIT:"INIT",LOADED:"LOADED",LOADED_FROM_CACHE:"LOADED_FROM_CACHE",ERROR:"ERROR",UPDATED_FEATURE:"UPDATED_FEATURE"},g={equals:function(e,t){return e===t},contains:function(e,t){return"string"==typeof e&&-1<e.indexOf(t)},startsWith:function(e,t){return"string"==typeof e&&e.startsWith(t)},endsWith:function(e,t){return"string"==typeof e&&e.endsWith(t)},matches:function(e,t){return"string"==typeof e&&"string"==typeof t&&new RegExp(t).test(e)},in:function(e,t){return"string"==typeof e&&Array.isArray(t)&&-1<t.indexOf(e)},notIn:function(e,t){return"string"==typeof e&&Array.isArray(t)&&t.indexOf(e)<0},before:function(e,t){return e=m(e),t=m(t),"number"==typeof e&&"number"==typeof t&&e<t},after:function(e,t){return e=m(e),t=m(t),"number"==typeof e&&"number"==typeof t&&t<e},greaterThan:function(e,t){return t<e},greaterThanOrEqual:function(e,t){return t<=e},lessThan:function(e,t){return e<t},lessThanOrEqual:function(e,t){return e<=t}};function m(e){return"string"==typeof e?Date.parse(e):e instanceof Date?e.getTime():e}var w=function(){return!1};function b(){}b.prototype={on:function(e,t,n){var r=this.e||(this.e={});return(r[e]||(r[e]=[])).push({fn:t,ctx:n}),this},once:function(e,t,n){var r=this;function i(){r.off(e,i),t.apply(n,arguments)}return i._=t,this.on(e,i,n)},emit:function(e){for(var t=[].slice.call(arguments,1),n=((this.e||(this.e={}))[e]||[]).slice(),r=0,i=n.length;r<i;r++)n[r].fn.apply(n[r].ctx,t);return this},off:function(e,t){var n=this.e||(this.e={}),r=n[e],i=[];if(r&&t)for(var o=0,s=r.length;o<s;o++)r[o].fn!==t&&r[o].fn._!==t&&i.push(r[o]);return i.length?n[e]=i:delete n[e],this}};var O=b;var R,E=(function(i,o){var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){var t=!1;if("object"===s(o)&&(i.exports=e(),t=!0),!t){var n=window.Cookies,r=window.Cookies=e();r.noConflict=function(){return window.Cookies=n,r}}}(function(){function d(){for(var e=0,t={};e<arguments.length;e++){var n=arguments[e];for(var r in n)t[r]=n[r]}return t}return function e(h){function p(e,t,n){var r;if("undefined"!=typeof document){if(1<arguments.length){if("number"==typeof(n=d({path:"/"},p.defaults,n)).expires){var i=new Date;i.setMilliseconds(i.getMilliseconds()+864e5*n.expires),n.expires=i}n.expires=n.expires?n.expires.toUTCString():"";try{r=JSON.stringify(t),/^[\{\[]/.test(r)&&(t=r)}catch(e){}t=h.write?h.write(t,e):encodeURIComponent(String(t)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),e=(e=(e=encodeURIComponent(String(e))).replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent)).replace(/[\(\)]/g,escape);var o="";for(var s in n)n[s]&&(o+="; "+s,!0!==n[s]&&(o+="="+n[s]));return document.cookie=e+"="+t+o}e||(r={});for(var a=document.cookie?document.cookie.split("; "):[],u=/(%[0-9A-Z]{2})+/g,f=0;f<a.length;f++){var c=a[f].split("="),l=c.slice(1).join("=");this.json||'"'!==l.charAt(0)||(l=l.slice(1,-1));try{var v=c[0].replace(u,decodeURIComponent);if(l=h.read?h.read(l,v):h(l,v)||l.replace(u,decodeURIComponent),this.json)try{l=JSON.parse(l)}catch(e){}if(e===v){r=l;break}e||(r[v]=l)}catch(e){}}return r}}return(p.set=p).get=function(e){return p.call(p,e)},p.getJSON=function(){return p.apply({json:!0},[].slice.call(arguments))},p.defaults={},p.remove=function(e,t){p(e,"",d(t,{expires:-1}))},p.withConverter=e,p}(function(){})})}(R={exports:{}},R.exports),R.exports),A=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},C=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();var I={baseUrl:"https://app.featureflow.io",eventsUrl:"https://events.featureflow.io",rtmUrl:"https://rtm.featureflow.io",streaming:!0,defaultFeatures:{},useCookies:!0,offline:!1},D=new Error("init() has not been called with a valid apiKey");function U(e,t,n){return localStorage.setItem("ff:v130:"+t+":"+e,JSON.stringify(n))}var k=function(){function o(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=this,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:function(){};if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.receivedInitialResponse=!1,this.emitter=new O,this.apiKey=e,!this.apiKey)throw D;(this.config=A({},I,r),u(this.config.baseUrl),f(this.config.eventsUrl),c(this.apiKey),this.updateUser(t),!this.config.offline&&this.config.streaming)&&(new window.EventSource(this.config.rtmUrl+"/api/js/v1/stream/"+this.apiKey).onmessage=function(e){var t=[];try{t=JSON.parse(e.data)}catch(e){}l(n.config.baseUrl,n.apiKey,n.user,t,function(e,t){e?(n.emitter.emit(y.ERROR,e),i(e)):(n.features=A({},n.features,t),U(n.apiKey,n.user.id,n.features),n.emitter.emit(y.UPDATED_FEATURE,t),i(void 0,t))})});this.on=this.emitter.on.bind(this.emitter),this.off=this.emitter.off.bind(this.emitter)}return C(o,[{key:"updateUser",value:function(){var n=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){},t=A({},e.attributes,{});this.user={id:e.id||this.getAnonymousId(),attributes:t};var i=new Date,o=i.getHours(),s=new Array(1);s[0]=o,this.currentContext={attributes:{"featureflow.date":[].concat(i),"featureflow.hourofday":s}},this.features=function(e,t){try{return JSON.parse(localStorage.getItem("ff:v130:"+t+":"+e)||"{}")}catch(e){return{}}}(this.apiKey,this.user.id),setTimeout(function(){n.emitter.emit(y.LOADED_FROM_CACHE,n.features),n.config.offline?setTimeout(function(){return n.features=n.config.defaultFeatures,U(n.apiKey,n.user.id,n.features),n.emitter.emit(y.INIT,n.features),n.emitter.emit(y.LOADED,n.features),r(void 0,n.features),n.user}):l(n.config.baseUrl,n.apiKey,n.user,[],function(e,t){return n.receivedInitialResponse=!0,e?(n.emitter.emit(y.ERROR,e),r(e)):(n.features=t||{},U(n.apiKey,n.user.id,n.features),n.emitter.emit(y.INIT,t),n.emitter.emit(y.LOADED,t),r(void 0,t)),n.user})},0)}},{key:"getFeatures",value:function(){return this.config.offline?this.evalAll(this.config.defaultFeatures):this.evalAll(this.features)}},{key:"getUser",value:function(){return this.user}},{key:"evaluate",value:function(e){if(this.config.offline)return new d(this.config.defaultFeatures[e]||"off");var t=this.features[e];if(void 0===t)return new d("off");var n=this.evalRules(t),r=new d(n);return h(this.user,e,r.value()),r}},{key:"evalAll",value:function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=this.evalRules(e[n]));return t}},{key:"evalRules",value:function(e){if("string"==typeof e)return e;for(var t in e.rules){var n=e.rules[t];if(this.ruleMatches(n))return n.variant}}},{key:"ruleMatches",value:function(e){if(!e.audience)return!0;for(var t in e.audience.conditions){var n=e.audience.conditions[t],r=!1,i=this.currentContext.attributes[n.target];for(var o in i){var s=i[o];if(a=n.operator,u=s,f=n.values,f=0<=["in","notIn"].indexOf(a)?f:f[0],(g[a]||w)(u,f)){r=!0;break}}if(!r)return!1}var a,u,f;return!0}},{key:"goal",value:function(e){if(!this.config.offline)return v(this.user,e,this.getFeatures(),function(){})}},{key:"getAnonymousId",value:function(){return localStorage.getItem("ff-anonymous-id")||this.resetAnonymousId()}},{key:"resetAnonymousId",value:function(){var e="anonymous:"+Math.random().toString(36).substring(2);return localStorage.setItem("ff-anonymous-id",e),this.config.useCookies&&E.set("ff-anonymous-id",e),e}},{key:"hasReceivedInitialResponse",value:function(){return this.receivedInitialResponse}}]),o}();function T(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return new k(e,t,n)}var S=y,x={init:T,events:S};void 0!==window.VERSION&&(module.exports.version=window.VERSION),e.init=T,e.events=S,e.default=x}(this.Featureflow=this.Featureflow||{});
