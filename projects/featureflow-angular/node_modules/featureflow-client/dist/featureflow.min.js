!function(e){"use strict";for(var i="1.3.6",u=function(e){for(var t,n=e.length,r=n%3,i=[],o=0,s=n-r;o<s;o+=16383)i.push(f(e,o,s<o+16383?s:o+16383));1===r?(t=e[n-1],i.push(a[t>>2]+a[t<<4&63]+"==")):2===r&&(t=(e[n-2]<<8)+e[n-1],i.push(a[t>>10]+a[t>>4&63]+a[t<<2&63]+"="));return i.join("")},a=[],t=[],n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",r=0,o=n.length;r<o;++r)a[r]=n[r],t[n.charCodeAt(r)]=r;function f(e,t,n){for(var r,i,o=[],s=t;s<n;s+=3)r=(e[s]<<16&16711680)+(e[s+1]<<8&65280)+(255&e[s+2]),o.push(a[(i=r)>>18&63]+a[i>>12&63]+a[i>>6&63]+a[63&i]);return o.join("")}t["-".charCodeAt(0)]=62,t["_".charCodeAt(0)]=63;var s=void 0;var c=void 0,l={events:[]},h=function(){var e=[];0<l.events.length&&(e.push.apply(e,function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(l.events)),l.events=[],p(s.eventsUrl+"/api/js/v1/event/"+s.apiKey,{method:"POST",body:e})),c=null},v=function(){c||(c=setTimeout(h,4e3))};function p(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:function(){},r=new XMLHttpRequest;return r.addEventListener("load",function(){200===r.status&&"application/json;charset=UTF-8"===r.getResponseHeader("Content-Type")?n(null,JSON.parse(r.responseText)):n(r.statusText||"non 200 response status code")}),r.addEventListener("error",function(){n("error connecting with server")}),r.open(t.method,e),r.setRequestHeader("X-Featureflow-Client","JavascriptClient/"+i),t.body?(r.setRequestHeader("Content-Type","application/json"),r.send(JSON.stringify(t.body))):r.send(),r}var d=function(e){s.baseUrl=e},y=function(e){s.eventsUrl=e},g=function(e){s.apiKey=e},m=function(e,t,n){var r,i,o=3<arguments.length&&void 0!==arguments[3]?arguments[3]:[],s=arguments[4],a=0<o.length?"?keys="+o.join(","):"";p(e+"/api/js/v1/evaluate/"+t+"/user/"+encodeURI((r=n,i=unescape(encodeURIComponent(JSON.stringify(r))),u(function(e){for(var t=[],n=0;n<e.length;n++)t.push(e.charCodeAt(n));return t}(i))))+a,{method:"GET"},s)},w=function(e,t,n){return v(l.events.push({type:"goal",goalKey:t,impressions:1,evaluatedFeatures:n,timestamp:new Date,user:e}))},b=function(e,t,n){return v(l.events.push({type:"evaluate",featureKey:t,evaluatedVariant:n,impressions:1,user:e,timestamp:new Date}))},R=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();var O=function(){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),this.storedValue=e.toLowerCase()}return R(t,[{key:"value",value:function(){return this.storedValue}},{key:"is",value:function(e){return e.toLowerCase()===this.value().toLowerCase()}},{key:"isOn",value:function(){return this.is("on")}},{key:"isOff",value:function(){return this.is("off")}}]),t}(),A={INIT:"INIT",LOADED:"LOADED",LOADED_FROM_CACHE:"LOADED_FROM_CACHE",ERROR:"ERROR",UPDATED_FEATURE:"UPDATED_FEATURE"},C={equals:function(e,t){return e===t},contains:function(e,t){return"string"==typeof e&&-1<e.indexOf(t)},startsWith:function(e,t){return"string"==typeof e&&e.startsWith(t)},endsWith:function(e,t){return"string"==typeof e&&e.endsWith(t)},matches:function(e,t){return"string"==typeof e&&"string"==typeof t&&new RegExp(t).test(e)},in:function(e,t){return"string"==typeof e&&Array.isArray(t)&&-1<t.indexOf(e)},notIn:function(e,t){return"string"==typeof e&&Array.isArray(t)&&t.indexOf(e)<0},before:function(e,t){return e=E(e),t=E(t),"number"==typeof e&&"number"==typeof t&&e<t},after:function(e,t){return e=E(e),t=E(t),"number"==typeof e&&"number"==typeof t&&t<e},greaterThan:function(e,t){return t<e},greaterThanOrEqual:function(e,t){return t<=e},lessThan:function(e,t){return e<t},lessThanOrEqual:function(e,t){return e<=t}};function E(e){return"string"==typeof e?Date.parse(e):e instanceof Date?e.getTime():e}var I=function(){return!1};function U(){}U.prototype={on:function(e,t,n){var r=this.e||(this.e={});return(r[e]||(r[e]=[])).push({fn:t,ctx:n}),this},once:function(e,t,n){var r=this;function i(){r.off(e,i),t.apply(n,arguments)}return i._=t,this.on(e,i,n)},emit:function(e){for(var t=[].slice.call(arguments,1),n=((this.e||(this.e={}))[e]||[]).slice(),r=0,i=n.length;r<i;r++)n[r].fn.apply(n[r].ctx,t);return this},off:function(e,t){var n=this.e||(this.e={}),r=n[e],i=[];if(r&&t)for(var o=0,s=r.length;o<s;o++)r[o].fn!==t&&r[o].fn._!==t&&i.push(r[o]);return i.length?n[e]=i:delete n[e],this}};var D=U;var k,T=(function(i,o){var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){var t=!1;if("object"===s(o)&&(i.exports=e(),t=!0),!t){var n=window.Cookies,r=window.Cookies=e();r.noConflict=function(){return window.Cookies=n,r}}}(function(){function d(){for(var e=0,t={};e<arguments.length;e++){var n=arguments[e];for(var r in n)t[r]=n[r]}return t}return function e(v){function p(e,t,n){var r;if("undefined"!=typeof document){if(1<arguments.length){if("number"==typeof(n=d({path:"/"},p.defaults,n)).expires){var i=new Date;i.setMilliseconds(i.getMilliseconds()+864e5*n.expires),n.expires=i}n.expires=n.expires?n.expires.toUTCString():"";try{r=JSON.stringify(t),/^[\{\[]/.test(r)&&(t=r)}catch(e){}t=v.write?v.write(t,e):encodeURIComponent(String(t)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),e=(e=(e=encodeURIComponent(String(e))).replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent)).replace(/[\(\)]/g,escape);var o="";for(var s in n)n[s]&&(o+="; "+s,!0!==n[s]&&(o+="="+n[s]));return document.cookie=e+"="+t+o}e||(r={});for(var a=document.cookie?document.cookie.split("; "):[],u=/(%[0-9A-Z]{2})+/g,f=0;f<a.length;f++){var c=a[f].split("="),l=c.slice(1).join("=");this.json||'"'!==l.charAt(0)||(l=l.slice(1,-1));try{var h=c[0].replace(u,decodeURIComponent);if(l=v.read?v.read(l,h):v(l,h)||l.replace(u,decodeURIComponent),this.json)try{l=JSON.parse(l)}catch(e){}if(e===h){r=l;break}e||(r[h]=l)}catch(e){}}return r}}return(p.set=p).get=function(e){return p.call(p,e)},p.getJSON=function(){return p.apply({json:!0},[].slice.call(arguments))},p.defaults={},p.remove=function(e,t){p(e,"",d(t,{expires:-1}))},p.withConverter=e,p}(function(){})})}(k={exports:{}},k.exports),k.exports),S=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},x=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();var F={baseUrl:"https://app.featureflow.io",eventsUrl:"https://events.featureflow.io",rtmUrl:"https://rtm.featureflow.io",streaming:!0,defaultFeatures:{},useCookies:!0,offline:!1},j=new Error("init() has not been called with a valid apiKey");function K(e,t,n){return localStorage.setItem("ff:v130:"+t+":"+e,JSON.stringify(n))}var N=function(){function o(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=this,r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=3<arguments.length&&void 0!==arguments[3]?arguments[3]:function(){};if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),this.receivedInitialResponse=!1,this.emitter=new D,this.apiKey=e,!this.apiKey)throw j;(this.config=S({},F,r),d(this.config.baseUrl),y(this.config.eventsUrl),g(this.apiKey),this.updateUser(t),!this.config.offline&&this.config.streaming)&&(new window.EventSource(this.config.rtmUrl+"/api/js/v1/stream/"+this.apiKey).onmessage=function(e){var t=[];try{t=JSON.parse(e.data)}catch(e){}m(n.config.baseUrl,n.apiKey,n.user,t,function(e,t){e?(n.emitter.emit(A.ERROR,e),i(e)):(n.features=S({},n.features,t),K(n.apiKey,n.user.id,n.features),n.emitter.emit(A.UPDATED_FEATURE,t),i(void 0,t))})});this.on=this.emitter.on.bind(this.emitter),this.off=this.emitter.off.bind(this.emitter)}return x(o,[{key:"updateUser",value:function(){var n=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){},t=S({},e.attributes,{});this.user={id:e.id||this.getAnonymousId(),attributes:t};var i=new Date,o=i.getHours(),s=new Array(1);s[0]=o,this.currentContext={attributes:{"featureflow.date":[].concat(i),"featureflow.hourofday":s}},this.features=function(e,t){try{return JSON.parse(localStorage.getItem("ff:v130:"+t+":"+e)||"{}")}catch(e){return{}}}(this.apiKey,this.user.id),setTimeout(function(){n.emitter.emit(A.LOADED_FROM_CACHE,n.features),n.config.offline?setTimeout(function(){return n.features=n.config.defaultFeatures,K(n.apiKey,n.user.id,n.features),n.emitter.emit(A.INIT,n.features),n.emitter.emit(A.LOADED,n.features),r(void 0,n.features),n.user}):m(n.config.baseUrl,n.apiKey,n.user,[],function(e,t){return n.receivedInitialResponse=!0,e?(n.emitter.emit(A.ERROR,e),r(e)):(n.features=t||{},K(n.apiKey,n.user.id,n.features),n.emitter.emit(A.INIT,t),n.emitter.emit(A.LOADED,t),r(void 0,t)),n.user})},0)}},{key:"getFeatures",value:function(){return this.config.offline?this.evalAll(this.config.defaultFeatures):this.evalAll(this.features)}},{key:"getUser",value:function(){return this.user}},{key:"evaluate",value:function(e){if(this.config.offline)return new O(this.config.defaultFeatures[e]||"off");var t=this.features[e];if(void 0===t)return new O("off");var n=this.evalRules(t),r=new O(n);return b(this.user,e,r.value()),r}},{key:"evalAll",value:function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[n]=this.evalRules(e[n]));return t}},{key:"evalRules",value:function(e){if("string"==typeof e)return e;for(var t in e.rules){var n=e.rules[t];if(this.ruleMatches(n))return n.variant}}},{key:"ruleMatches",value:function(e){if(!e.audience)return!0;for(var t in e.audience.conditions){var n=e.audience.conditions[t],r=!1,i=this.currentContext.attributes[n.target];for(var o in i){var s=i[o];if(a=n.operator,u=s,f=n.values,f=0<=["in","notIn"].indexOf(a)?f:f[0],(C[a]||I)(u,f)){r=!0;break}}if(!r)return!1}var a,u,f;return!0}},{key:"goal",value:function(e){if(!this.config.offline)return w(this.user,e,this.getFeatures(),function(){})}},{key:"getAnonymousId",value:function(){return localStorage.getItem("ff-anonymous-id")||this.resetAnonymousId()}},{key:"resetAnonymousId",value:function(){var e="anonymous:"+Math.random().toString(36).substring(2);return localStorage.setItem("ff-anonymous-id",e),this.config.useCookies&&T.set("ff-anonymous-id",e),e}},{key:"hasReceivedInitialResponse",value:function(){return this.receivedInitialResponse}}]),o}();function L(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};return new N(e,t,n)}var _=A,J={init:L,events:_};void 0!==window.VERSION&&(module.exports.version=window.VERSION),e.init=L,e.events=_,e.default=J}(this.Featureflow=this.Featureflow||{});
